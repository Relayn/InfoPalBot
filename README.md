# InfoPalBot - Информационный Telegram-бот

InfoPalBot - это Telegram-бот, предназначенный для предоставления пользователям актуальной информации по запросу и через систему подписок. Бот может сообщать прогноз погоды, последние новости и информацию о предстоящих событиях.

## Функционал

*   **Запрос информации по командам:**
    *   `/start` - Начало работы с ботом, регистрация пользователя.
    *   `/help` - Получение справки по доступным командам.
    *   `/weather [город]` - Получение текущего прогноза погоды для указанного города.
    *   `/news` - Получение последних главных новостей для России.
    *   `/events [город]` - Получение информации об актуальных событиях в указанном городе (поддерживаемые города: Москва, Санкт-Петербург, Новосибирск, Екатеринбург, Казань, Нижний Новгород).
*   **Подписки на рассылки:**
    *   `/subscribe` - Интерактивная подписка на рассылки (погода, новости, события).
    *   `/mysubscriptions` - Просмотр своих активных подписок.
    *   `/unsubscribe` - Отписка от рассылок.
    *   `/cancel` - Отмена текущего многошагового действия (например, процесса подписки).
    *   **Настройка частоты уведомлений:** Пользователи могут выбирать желаемую частоту получения рассылок при оформлении подписки (3, 6, 12 или 24 часа).
*   **Автоматические уведомления:** Бот периодически рассылает обновления подписчикам согласно их настройкам (погода, новости, события).
*   **Логирование действий:** Основные действия пользователей логируются в базу данных.

## Стек технологий

*   **Язык:** Python 3.10+
*   **Telegram Bot Framework:** Aiogram 3.x
*   **База данных:** SQLite (для простоты развертывания)
*   **ORM:** SQLModel
*   **HTTP-клиент:** httpx
*   **Планировщик задач:** APScheduler
*   **Управление зависимостями:** pip, `requirements.txt`
*   **Тестирование:** Pytest
*   **Форматирование кода:** Black, Ruff

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <URL_вашего_репозитория>
cd InfoPalBot
```

### 2. Создание и активация виртуального окружения

Рекомендуется использовать виртуальное окружение для изоляции зависимостей проекта.

```bash
# Windows
python -m venv .venv
.venv\Scripts\activate

# macOS / Linux
python3 -m venv .venv
source .venv/bin/activate
```

### 3. Установка зависимостей

Все необходимые библиотеки перечислены в файле `requirements.txt`.

```bash
pip install -r requirements.txt
```

### 4. Настройка переменных окружения

Скопируйте файл `.env.example` в `.env` и заполните его необходимыми значениями:

```bash
cp .env.example .env
```

Откройте файл `.env` в текстовом редакторе и укажите:

*   `TELEGRAM_BOT_TOKEN`: Токен вашего Telegram-бота (получается у @BotFather).
*   `DATABASE_URL`: Строка подключения к базе данных. По умолчанию настроено на SQLite: `sqlite:///./app/database/infopalbot.db`. Файл БД будет создан в `app/database/`.
*   `WEATHER_API_KEY`: API ключ для OpenWeatherMap (необходим для команды `/weather` и рассылки погоды).
*   `NEWS_API_KEY`: API ключ для NewsAPI.org (необходим для команды `/news` и рассылки новостей).
*   `LOG_LEVEL`: Уровень логирования (например, `INFO`, `DEBUG`).

**Примечание:** Для API событий KudaGo API ключ не требуется.

### 5. Запуск бота

Бот запускается из корневой директории проекта как модуль:

```bash
python -m app.bot.main
```

При первом запуске будут автоматически созданы таблицы в базе данных SQLite.

### 6. Запуск тестов (опционально)

Для запуска unit-тестов:

```bash
pytest
```

### 7. Запуск с помощью Docker

Для сборки и запуска проекта с использованием Docker выполните следующие шаги.

**Сборка Docker-образа:**

Из корневой директории проекта выполните команду:

```bash
docker build -t infopalbot .
```

**Запуск Docker-контейнера:**

Для запуска контейнера необходимо передать переменные окружения. Это можно сделать, создав файл `.env` (как описано в шаге 4) и передав его Docker.

```bash
docker run --env-file .env --name infopalbot-container -d infopalbot
```

*   `--env-file .env`: Передает переменные окружения из файла `.env` в контейнер.
*   `--name infopalbot-container`: Задает имя контейнеру для удобства управления.
*   `-d`: Запускает контейнер в фоновом (detached) режиме.
*   `infopalbot`: Имя Docker-образа, который был собран на предыдущем шаге.

**Просмотр логов контейнера:**

```bash
docker logs -f infopalbot-container
```

**Остановка контейнера:**

```bash
docker stop infopalbot-container
```

### 8. Запуск с помощью Docker Compose (Рекомендуемый способ)

Использование Docker Compose - это самый простой и надежный способ для запуска приложения в разработке, так как он автоматически управляет контейнером и его настройками.

**Запуск:**

Убедитесь, что у вас есть файл `.env` (см. шаг 4). Затем выполните команду из корневой директории проекта:
```bash
docker-compose up --build -d
```
* `--build`: Пересобирает образ, если в коде были изменения.
* `-d`: Запускает контейнер в фоновом режиме.

**Просмотр логов:**
```bash
docker-compose logs -f
```

**Остановка:**
```bash
docker-compose down
```

## Структура проекта

```
InfoPalBot/
├── app/                    # Основной код приложения
│   ├── api_clients/        # Клиенты для внешних API (погода, новости, события)
│   ├── bot/                # Логика Telegram-бота (обработчики, FSM)
│   │   ├── constants.py    # Константы для бота
│   │   └── main.py         # Главный файл бота
│   ├── database/           # Работа с базой данных (модели, CRUD, сессии)
│   ├── scheduler/          # Планировщик задач (APScheduler)
│   │   ├── main.py         # Инициализация планировщика
│   │   └── tasks.py        # Задачи для планировщика
│   └── config.py           # Загрузка настроек из .env
├── tests/                  # Тесты
│   └── unit/               # Unit-тесты
├── .env.example            # Пример файла переменных окружения
├── .gitignore
├── PLANNING.md             # План проекта
├── README.md               # Этот файл
├── requirements.txt        # Зависимости проекта
└── TASK.md                 # Список задач
```

## Дальнейшие улучшения (TODO)

*   Более продвинутое логирование (например, в файлы с ротацией).
*   Настройка Coverage report для тестов.
*   Добавление Docstrings ко всем функциям и классам.
*   Настройка CI/CD для автоматической сборки и тестирования.

## Лицензия

Этот проект распространяется под лицензией MIT.